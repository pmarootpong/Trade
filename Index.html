<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js and date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
            getFirestore, doc, onSnapshot, setDoc
        };
    </script>
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, select, textarea { background-color: #374151; border-color: #4b5563; color: #d1d5db; border-radius: 0.375rem; }
        input:focus, select:focus, textarea:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-color: #3b82f6; border-color: #3b82f6; }
        .table-auto th { background-color: #1f2937; }
        .table-auto tr:nth-child(even) { background-color: #1f2937; }
        .table-auto tr:nth-child(odd) { background-color: #374151; }
        .btn-primary { background-color: #3b82f6; color: white; } .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; } .btn-secondary:hover { background-color: #6b7280; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .buy, .long, .deposit { color: #22c55e; } .sell, .short, .withdrawal { color: #ef4444; }
        #main-app-container.hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Login Container -->
    <div id="login-container" class="max-w-7xl mx-auto text-center py-16">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Crypto Trading Dashboard Pro</h1>
        <p class="text-gray-400 mt-2 mb-6">กรุณาลงชื่อเข้าใช้ด้วยบัญชี Google เพื่อบันทึกและซิงค์ข้อมูลบนคลาวด์</p>
        <button id="login-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold inline-flex items-center">
            <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.333,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            Sign in with Google
        </button>
    </div>

    <!-- Main App Container -->
    <div id="main-app-container" class="max-w-7xl mx-auto hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="text-center sm:text-left">
                 <h1 class="text-3xl md:text-4xl font-bold text-white">Crypto Trading Dashboard Pro</h1>
                 <p id="user-email" class="text-gray-400 mt-2">Logged in as: -</p>
            </div>
            <button id="logout-btn" class="btn-secondary mt-4 sm:mt-0 px-4 py-2 rounded-lg font-semibold">Logout</button>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 flex flex-wrap justify-center gap-2">
            <button class="tab-button active px-4 py-2 rounded-md font-semibold" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('planner')">Trade Planner</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('tradesLog')">Trades Log</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('costBasis')">Cost Basis</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('cash')">Cash</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('settings')">Settings</button>
        </div>

        <main>
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Stat Cards -->
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Total Portfolio Value</h3><p id="db-total-portfolio-value" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Available Cash</h3><p id="db-cash-balance" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Realized PnL</h3><p id="db-realized-pnl" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Win Rate</h3><p id="db-win-rate" class="text-2xl font-bold text-white">N/A</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Average R Multiple</h3><p id="db-avg-r" class="text-2xl font-bold text-white">N/A</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-white mb-4">Portfolio Equity Curve</h2><canvas id="equity-chart"></canvas></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-white mb-4">Crypto Allocation</h2><p class="text-sm text-gray-400 -mt-4 mb-2">Total Crypto Value: <span id="db-crypto-value" class="font-semibold">0.00 THB</span></p><canvas id="holdings-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">Trade Insights (Open Positions)</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left table-auto"><thead><tr><th class="p-2">Symbol</th><th class="p-2">Side</th><th class="p-2">Entry</th><th class="p-2">Current Price</th><th class="p-2">Diff to TP1 (%)</th><th class="p-2">Diff to TP2 (%)</th></tr></thead><tbody id="insight-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- Other Tabs -->
            <div id="planner" class="tab-content space-y-6">
                 <!-- Planner content remains the same -->
            </div>
            <div id="tradesLog" class="tab-content space-y-6">
                 <!-- Trades Log content remains the same -->
            </div>
            <div id="costBasis" class="tab-content space-y-6">
                 <!-- Cost Basis content remains the same -->
            </div>

            <!-- Cash Management Tab (NEW) -->
            <div id="cash" class="tab-content space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">บันทึกเงินสด (Cash Transaction)</h2>
                    <form id="add-cash-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="col-span-1"><label for="cash-date" class="block mb-1 text-sm">Date</label><input type="date" id="cash-date" class="w-full p-2" required></div>
                        <div class="col-span-1"><label for="cash-type" class="block mb-1 text-sm">Type</label><select id="cash-type" class="w-full p-2" required><option value="DEPOSIT">ฝาก (Deposit)</option><option value="WITHDRAWAL">ถอน (Withdrawal)</option></select></div>
                        <div class="col-span-1"><label for="cash-amount" class="block mb-1 text-sm">Amount (THB)</label><input type="number" step="any" id="cash-amount" placeholder="e.g., 50000" class="w-full p-2" required></div>
                        <div class="col-span-1"><button type="submit" class="w-full btn-primary p-2 rounded font-semibold">Add Transaction</button></div>
                    </form>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">ประวัติธุรกรรมเงินสด</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-auto text-sm">
                            <thead><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Amount (THB)</th><th class="p-2">Action</th></tr></thead>
                            <tbody id="cash-log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto">
                    <h2 class="text-xl font-bold text-white mb-4">Settings & Configuration</h2>
                    <form id="settings-form" class="space-y-4">
                        <!-- Settings form content remains mostly the same -->
                        <div class="border-t border-gray-600 pt-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-white">Real-time Prices (BitKub)</h3>
                                <button type="button" id="refresh-prices-btn" class="btn-secondary px-3 py-1 rounded text-sm">Refresh</button>
                            </div>
                            <p class="text-xs text-gray-400 mb-2">Powered by BitKub API. Updates automatically on load.</p>
                            <div><label class="block mb-1">Current Price ETH (THB)</label><input type="number" step="any" id="current-price-eth" class="w-full p-2 bg-gray-600" readonly></div>
                            <div><label class="block mb-1">Current Price HBAR (THB)</label><input type="number" step="any" id="current-price-hbar" class="w-full p-2 bg-gray-600" readonly></div>
                        </div>
                        <button type="submit" class="w-full btn-primary p-2 rounded font-semibold">Save Settings</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Closing Trade -->
    <div id="close-trade-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <!-- Modal content remains the same -->
    </div>
    
    <script type="module">
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1tCvl2eIYbXBnaHwC353mp_z6lApC8lY",
            authDomain: "trading-jamebond.firebaseapp.com",
            projectId: "trading-jamebond",
            storageBucket: "trading-jamebond.firebasestorage.app",
            messagingSenderId: "225878580134",
            appId: "1:225878580134:web:35f4f42a56cf11c4f80d67",
            measurementId: "G-D5SD78ZF6P"
        };
        
        // --- GLOBAL VARIABLES & STATE ---
        const { initializeApp } = window.firebase;
        const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = window.firebase;
        const { getFirestore, doc, onSnapshot, setDoc } = window.firebase;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userDataUnsubscribe = null;
        
        // --- App State ---
        let settings = {};
        let costBasisLog = [];
        let tradesLog = [];
        let tradePlans = [];
        let cashLog = []; // NEW: For cash transactions
        const defaultSettings = {
            portfolioCapital: 100000, feePercent: 0.1, riskEth: 1000, riskHbar: 500,
            targetR1: 1.5, targetR2: 3.0, currentPriceEth: 0, currentPriceHbar: 0
        };
        
        // --- AUTH & DATA MANAGEMENT ---
        onAuthStateChanged(auth, user => {
            // Auth logic remains the same
        });

        async function saveData() {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, { settings, costBasisLog, tradesLog, tradePlans, cashLog }); // ADD cashLog to save
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        function loadDataForUser(uid) {
            const userDocRef = doc(db, "users", uid);
            userDataUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    settings = data.settings || { ...defaultSettings };
                    costBasisLog = data.costBasisLog || [];
                    tradesLog = data.tradesLog || [];
                    tradePlans = data.tradePlans || [];
                    cashLog = data.cashLog || []; // ADD cashLog to load
                } else {
                    // Create initial doc for new user
                    settings = { ...defaultSettings };
                    costBasisLog = []; tradesLog = []; tradePlans = []; cashLog = [];
                    saveData();
                }
                loadSettingsToUI();
                fetchRealTimePrices().then(() => renderAll());
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            if (!currentUser) {
                // Clear UI if logged out...
                return;
            }
            const portfolioStats = calculatePortfolioStats();
            renderDashboard(portfolioStats);
            renderTradePlanner();
            renderTradesLog();
            renderCostBasisLog();
            renderCashLog(); // NEW
            renderCharts(portfolioStats);
        }
        
        // --- API & UTILITIES (UPDATED FOR BITKUB) ---
        async function fetchRealTimePrices() {
            try {
                const response = await fetch('https://api.bitkub.com/api/market/ticker');
                if (!response.ok) throw new Error('BitKub API response was not ok');
                const tickers = await response.json();
                if (tickers['THB_ETH']) settings.currentPriceEth = parseFloat(tickers['THB_ETH'].last);
                if (tickers['THB_HBAR']) settings.currentPriceHbar = parseFloat(tickers['THB_HBAR'].last);
                
                document.getElementById('current-price-eth').value = settings.currentPriceEth || 0;
                document.getElementById('current-price-hbar').value = settings.currentPriceHbar || 0;
            } catch (error) {
                console.error("Failed to fetch BitKub prices:", error);
            }
        }
        document.getElementById('refresh-prices-btn').addEventListener('click', () => fetchRealTimePrices().then(() => renderAll()));
        
        // --- PORTFOLIO CALCULATION (NEW CORE LOGIC) ---
        function calculatePortfolioStats() {
            const totalDeposits = cashLog.filter(t => t.type === 'DEPOSIT').reduce((sum, t) => sum + t.amount, 0);
            const totalWithdrawals = cashLog.filter(t => t.type === 'WITHDRAWAL').reduce((sum, t) => sum + t.amount, 0);

            const totalBuys = costBasisLog.filter(t => t.action === 'BUY').reduce((sum, t) => sum + t.amount, 0);
            const totalSells = costBasisLog.filter(t => t.action === 'SELL').reduce((sum, t) => sum + t.amount, 0);

            const availableCash = totalDeposits - totalWithdrawals - totalBuys + totalSells;

            const holdings = {}; // Calculate current holdings...
            [...costBasisLog].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(tx => {
                if(!holdings[tx.symbol]) holdings[tx.symbol] = { cumQty: 0, cumCost: 0 };
                const qty = tx.amount / tx.price;
                const feeAdjustedQty = qty * (1 - (settings.feePercent/100));

                if (tx.action === 'BUY') {
                    holdings[tx.symbol].cumQty += feeAdjustedQty;
                    holdings[tx.symbol].cumCost += tx.amount;
                } else {
                    const avgCost = holdings[tx.symbol].cumQty > 0 ? holdings[tx.symbol].cumCost / holdings[tx.symbol].cumQty : 0;
                    holdings[tx.symbol].cumQty -= qty; // Sell amount does not have fee deduction on qty
                    holdings[tx.symbol].cumCost -= qty * avgCost;
                }
                if (holdings[tx.symbol].cumQty < 1e-9) holdings[tx.symbol].cumQty = 0;
                if (holdings[tx.symbol].cumCost < 0) holdings[tx.symbol].cumCost = 0;
            });
            
            const totalCryptoValue = Object.keys(holdings).reduce((sum, symbol) => {
                const currentPrice = symbol.toUpperCase() === 'ETH' ? settings.currentPriceEth : settings.currentPriceHbar;
                return sum + (holdings[symbol].cumQty * (currentPrice || 0));
            }, 0);

            const totalPortfolioValue = totalCryptoValue + availableCash;
            const realizedPnL = tradesLog.filter(t => t.status === 'CLOSED').reduce((sum, t) => sum + t.actualPnl, 0);

            return { availableCash, totalCryptoValue, totalPortfolioValue, realizedPnL, holdings };
        }

        // --- DASHBOARD & CHARTS (UPDATED) ---
        function renderDashboard(stats) {
            document.getElementById('db-total-portfolio-value').innerText = `${stats.totalPortfolioValue.toFixed(2)} THB`;
            document.getElementById('db-cash-balance').innerText = `${stats.availableCash.toFixed(2)} THB`;
            document.getElementById('db-realized-pnl').innerText = `${stats.realizedPnL.toFixed(2)} THB`;
            document.getElementById('db-crypto-value').innerText = `${stats.totalCryptoValue.toFixed(2)} THB`;
            
            // Other stats remain the same logic
            const closedTrades = tradesLog.filter(t => t.status === 'CLOSED');
            const wins = closedTrades.filter(t => t.actualPnl > 0).length;
            document.getElementById('db-win-rate').innerText = closedTrades.length > 0 ? `${(wins / closedTrades.length * 100).toFixed(2)}%` : 'N/A';
            const totalR = closedTrades.reduce((sum, t) => sum + t.rMultiple, 0);
            document.getElementById('db-avg-r').innerText = closedTrades.length > 0 ? (totalR / closedTrades.length).toFixed(2) : 'N/A';
        }
        
        function renderCharts(stats) {
            // Equity Curve (UPDATED LOGIC)
            const timelineEvents = [
                ...cashLog.map(t => ({ date: t.date, amount: t.type === 'DEPOSIT' ? t.amount : -t.amount })),
                ...tradesLog.filter(t => t.status === 'CLOSED').map(t => ({ date: t.exitDate, amount: t.actualPnl }))
            ].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let cumulativeValue = 0;
            const equityData = timelineEvents.map(event => {
                cumulativeValue += event.amount;
                return { x: new Date(event.date), y: cumulativeValue };
            });

            const ctxEquity = document.getElementById('equity-chart').getContext('2d');
            if(window.equityChart) window.equityChart.destroy();
            window.equityChart = new Chart(ctxEquity, {
                type: 'line',
                data: { datasets: [{ label: 'Portfolio Equity (THB)', data: equityData, borderColor: '#3b82f6', tension: 0.1 }] },
                options: { scales: { x: { type: 'time', time: { unit: 'day' }, adapters: { date: { locale: 'en-US' } } } } }
            });

            // Holdings Pie Chart (uses stats.holdings)
            const ctxHoldings = document.getElementById('holdings-chart').getContext('2d');
            if(window.holdingsChart) window.holdingsChart.destroy();
            window.holdingsChart = new Chart(ctxHoldings, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.holdings).filter(s => stats.holdings[s].cumCost > 1),
                    datasets: [{
                        label: 'Crypto Value (THB)',
                        data: Object.values(stats.holdings).filter(h => h.cumCost > 1).map(h => h.cumCost),
                        backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'],
                    }]
                }
            });
        }
        
        // --- CASH MANAGEMENT (NEW) ---
        function renderCashLog() {
            const body = document.getElementById('cash-log-body');
            body.innerHTML = '';
            [...cashLog].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
                body.innerHTML += `
                    <tr>
                        <td class="p-2">${tx.date}</td>
                        <td class="p-2 ${tx.type.toLowerCase()}">${tx.type}</td>
                        <td class="p-2">${tx.amount.toFixed(2)}</td>
                        <td class="p-2"><button class="text-red-500 hover:text-red-400" onclick="deleteCashItem('${tx.id}')">Delete</button></td>
                    </tr>`;
            });
        }

        document.getElementById('add-cash-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newTx = {
                id: `cash_${new Date().getTime()}`,
                date: document.getElementById('cash-date').value,
                type: document.getElementById('cash-type').value,
                amount: parseFloat(document.getElementById('cash-amount').value)
            };
            cashLog.push(newTx);
            await saveData();
            e.target.reset();
        });

        window.deleteCashItem = async (id) => {
            if (confirm('Are you sure you want to delete this cash transaction?')) {
                cashLog = cashLog.filter(tx => tx.id !== id);
                await saveData();
            }
        };

        // --- Other functions (Planner, Logs, Modals) remain largely unchanged ---
        // ... (full implementation of other functions would go here)
        
    </script>
</body>
</html>


