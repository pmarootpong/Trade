<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js and date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
            getFirestore, doc, onSnapshot, setDoc
        };
    </script>
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, select, textarea { background-color: #374151; border-color: #4b5563; color: #d1d5db; border-radius: 0.375rem; }
        input:focus, select:focus, textarea:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-color: #3b82f6; border-color: #3b82f6; }
        .table-auto th { background-color: #1f2937; }
        .table-auto tr:nth-child(even) { background-color: #1f2937; }
        .table-auto tr:nth-child(odd) { background-color: #374151; }
        .btn-primary { background-color: #3b82f6; color: white; } .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; } .btn-secondary:hover { background-color: #6b7280; }
        .btn-success { background-color: #22c55e; color: white; } .btn-success:hover { background-color: #16a34a; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-primary:disabled { background-color: #4b5563; opacity: 0.5; cursor: not-allowed; }
        .buy, .long, .deposit { color: #22c55e; } .sell, .short, .withdrawal { color: #ef4444; }
        #main-app-container.hidden { display: none; }
        .checklist-item { display: flex; align-items: center; }
        .checklist-item input { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Login Container -->
    <div id="login-container" class="max-w-7xl mx-auto text-center py-16">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Crypto Trading Dashboard Pro</h1>
        <p class="text-gray-400 mt-2 mb-6">กรุณาลงชื่อเข้าใช้ด้วยบัญชี Google เพื่อบันทึกและซิงค์ข้อมูลบนคลาวด์</p>
        <button id="login-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold inline-flex items-center">
             <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.333,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            Sign in with Google
        </button>
    </div>

    <!-- Main App Container -->
    <div id="main-app-container" class="max-w-7xl mx-auto hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div class="text-center sm:text-left">
                 <h1 class="text-3xl md:text-4xl font-bold text-white">Crypto Trading Dashboard Pro</h1>
                 <p id="user-email" class="text-gray-400 mt-2">Logged in as: -</p>
            </div>
            <button id="logout-btn" class="btn-secondary mt-4 sm:mt-0 px-4 py-2 rounded-lg font-semibold">Logout</button>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 flex flex-wrap justify-center gap-2">
            <button class="tab-button active px-4 py-2 rounded-md font-semibold" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('planner')">Trade Planner</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('tradesLog')">Trades Log</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('costBasis')">Cost Basis</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('cash')">Cash</button>
            <button class="tab-button px-4 py-2 rounded-md font-semibold" onclick="showTab('settings')">Settings</button>
        </div>

        <main>
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active space-y-6">
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Total Portfolio Value</h3><p id="db-total-portfolio-value" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Available Cash</h3><p id="db-cash-balance" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Realized PnL</h3><p id="db-realized-pnl" class="text-2xl font-bold text-white">0.00 THB</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Win Rate</h3><p id="db-win-rate" class="text-2xl font-bold text-white">N/A</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm font-medium">Average R Multiple</h3><p id="db-avg-r" class="text-2xl font-bold text-white">N/A</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-white mb-4">Portfolio Equity Curve</h2><canvas id="equity-chart"></canvas></div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-white mb-4">Crypto Allocation</h2><p class="text-sm text-gray-400 -mt-4 mb-2">Total Crypto Value: <span id="db-crypto-value" class="font-semibold">0.00 THB</span></p><canvas id="holdings-chart"></canvas></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">Trade Insights (Open Positions)</h2>
                    <div class="overflow-x-auto"><table class="w-full text-left table-auto"><thead><tr><th class="p-2">Symbol</th><th class="p-2">Side</th><th class="p-2">Entry</th><th class="p-2">Current Price</th><th class="p-2">Diff to TP1 (%)</th><th class="p-2">Diff to TP2 (%)</th></tr></thead><tbody id="insight-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- Planner Tab -->
            <div id="planner" class="tab-content space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">สร้างแผนการเทรดใหม่ (New Trade Plan)</h2>
                    <form id="trade-plan-form" class="space-y-4">
                        <!-- Step 1: Main Info -->
                        <fieldset class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm mb-1">Symbol</label>
                                    <select id="plan-symbol" class="w-full p-2 uppercase" required></select>
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm mb-1 invisible md:visible">Current Price</label>
                                    <p id="selected-symbol-price" class="p-2 text-gray-300">-</p>
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm mb-1">Risk (% of Portfolio)</label>
                                    <input type="number" step="0.1" id="plan-risk-percent" placeholder="e.g., 1.5" class="w-full p-2" required>
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm mb-1">Strategy</label>
                                    <input type="text" id="plan-strategy" placeholder="e.g., Breakout" class="w-full p-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Notes / Timeframe Analysis</label>
                                <textarea id="plan-notes" placeholder="บันทึกกลยุทธ์และแนวคิดการเทรด..." class="w-full p-2" rows="3"></textarea>
                            </div>
                        </fieldset>

                        <!-- Step 2: Scaling Plan -->
                        <fieldset class="space-y-3 pt-4">
                           <h3 class="text-lg font-semibold text-white">แผนการเข้า (Scaling Plan)</h3>
                           <div id="plan-entries-container" class="space-y-3"></div>
                           <button type="button" id="add-plan-entry-btn" class="btn-secondary p-2 rounded font-semibold w-full">เพิ่มไม้ (Add Entry)</button>
                        </fieldset>

                        <!-- Step 3: Pre-trade Checklist -->
                        <fieldset class="space-y-3 pt-4 border-t border-gray-700">
                             <h3 class="text-lg font-semibold text-white">Pre-trade Checklist</h3>
                             <div id="checklist-container" class="space-y-4 p-4 bg-gray-900 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                    <div>
                                        <h4 class="font-semibold text-white mb-2">1) Trend Direction</h4>
                                        <div class="pl-4 space-y-2">
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box" required> ราคาอยู่เหนือ/ต่ำกว่า EMA20 & EMA50</label>
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box"> EMA20/EMA50 Cross (Golden/Death)</label>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-white mb-2">2) Momentum Confirmation</h4>
                                        <div class="pl-4 space-y-2">
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box" required> RSI(14) > 50 (Buy) or < 50 (Sell)</label>
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box"> ไม่มีสัญญาณ Overbought/Oversold</label>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-white mb-2">3) Volume Check</h4>
                                        <div class="pl-4 space-y-2">
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box"> Volume สูงกว่าค่าเฉลี่ยในช่วง Breakout</label>
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box"> ไม่มีสัญญาณ Divergence</label>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-white mb-2">5) Execution Rules</h4>
                                        <div class="pl-4 space-y-2">
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box" required> ยืนยันการแบ่งไม้ตามแผน</label>
                                           <label class="checklist-item"><input type="checkbox" class="checklist-box"> วางแผนจัดการ Trade หลังแตะ TP1</label>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </fieldset>

                        <button type="submit" id="create-plan-btn" class="w-full btn-primary p-3 rounded font-semibold" disabled>สร้างแผนการเทรด (Create Plan)</button>
                    </form>
                </div>
                 <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4">แผนการเทรดที่ยังไม่ได้ดำเนินการ (Active Plans)</h2>
                    <div id="active-plans-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Other Tabs -->
            <div id="tradesLog" class="tab-content space-y-6"></div>
            <div id="costBasis" class="tab-content space-y-6"></div>
            <div id="cash" class="tab-content space-y-6"></div>

             <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto">
                    <h2 class="text-xl font-bold text-white mb-4">Settings & Configuration</h2>
                    <form id="settings-form" class="space-y-4">
                        <div><label class="block mb-1">Fee % (BitKub)</label><input type="number" step="0.01" id="fee-percent" class="w-full p-2"></div>
                        <div><label class="block mb-1">Target R for TP1</label><input type="number" step="0.1" id="target-r1" class="w-full p-2"></div>
                        <div><label class="block mb-1">Target R for TP2</label><input type="number" step="0.1" id="target-r2" class="w-full p-2"></div>
                        <div class="border-t border-gray-700 pt-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-white">Real-time Prices (BitKub)</h3>
                                <p class="text-xs text-gray-400">Auto-updates every 30s</p>
                            </div>
                            <p id="last-updated-time" class="text-xs text-gray-500 mb-2">Last updated: -</p>
                        </div>
                        <button type="submit" class="w-full btn-primary p-2 rounded font-semibold">Save Settings</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Closing Trade -->
    <div id="close-trade-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm"><h2 class="text-xl font-bold text-white mb-4">Close Trade</h2><form id="close-trade-form"><input type="hidden" id="close-trade-id"><div><label class="block mb-1">Exit Price</label><input type="number" step="any" id="exit-price" class="w-full p-2 rounded mb-4" required></div><div><label class="block mb-1">Exit Date</label><input type="date" id="exit-date" class="w-full p-2 rounded mb-4" required></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded">Confirm Close</button></div></form></div>
    </div>
    
    <script type="module">
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC1tCvl2eIYbXBnaHwC353mp_z6lApC8lY",
            authDomain: "trading-jamebond.firebaseapp.com",
            projectId: "trading-jamebond",
            storageBucket: "trading-jamebond.firebasestorage.app",
            messagingSenderId: "225878580134",
            appId: "1:225878580134:web:35f4f42a56cf11c4f80d67",
            measurementId: "G-D5SD78ZF6P"
        };
        
        // --- GLOBAL VARIABLES & STATE ---
        const { initializeApp } = window.firebase;
        const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = window.firebase;
        const { getFirestore, doc, onSnapshot, setDoc } = window.firebase;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userDataUnsubscribe = null;
        let priceUpdateInterval = null;
        let bitkubTickers = {};
        
        let settings = {};
        let costBasisLog = [];
        let tradesLog = [];
        let tradePlans = [];
        let cashLog = [];
        const defaultSettings = {
            feePercent: 0.25, targetR1: 1.5, targetR2: 3.0
        };

        const loginContainer = document.getElementById('login-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const userEmailEl = document.getElementById('user-email');
        
        // --- AUTH & DATA MANAGEMENT ---
        document.getElementById('login-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(err => console.error("Login failed:", err.message)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                userEmailEl.textContent = `Logged in as: ${user.email}`;
                loadDataForUser(user.uid);
                if (priceUpdateInterval) clearInterval(priceUpdateInterval);
                fetchRealTimePrices(true); // Initial fetch with dropdown population
                priceUpdateInterval = setInterval(() => fetchRealTimePrices(false), 30000);
            } else {
                currentUser = null;
                if (userDataUnsubscribe) userDataUnsubscribe();
                if (priceUpdateInterval) clearInterval(priceUpdateInterval);
                loginContainer.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                settings = {}; costBasisLog = []; tradesLog = []; tradePlans = []; cashLog = [];
                renderAll();
            }
        });

        async function saveData() {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, { settings, costBasisLog, tradesLog, tradePlans, cashLog });
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        function loadDataForUser(uid) {
            const userDocRef = doc(db, "users", uid);
            userDataUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    settings = data.settings || { ...defaultSettings };
                    costBasisLog = data.costBasisLog || [];
                    tradesLog = data.tradesLog || [];
                    tradePlans = data.tradePlans || [];
                    cashLog = data.cashLog || [];
                } else {
                    settings = { ...defaultSettings };
                    costBasisLog = []; tradesLog = []; tradePlans = []; cashLog = [];
                    saveData();
                }
                loadSettingsToUI();
                renderAll();
            }, (error) => {
                console.error("Error loading data:", error);
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            if (!currentUser) { return; }
            const portfolioStats = calculatePortfolioStats();
            renderDashboard(portfolioStats);
            renderTradePlanner();
            renderTradesLog();
            renderCostBasisLog();
            renderCashLog();
            renderCharts(portfolioStats);
        }
        
        // --- API & UTILITIES ---
        async function fetchRealTimePrices(populateDropdown = false) {
            try {
                const response = await fetch('https://api.bitkub.com/api/market/ticker');
                if (!response.ok) throw new Error('BitKub API response was not ok');
                bitkubTickers = await response.json();
                
                if (populateDropdown) {
                    populateSymbolDropdown();
                }
                updateSymbolPrice();
                document.getElementById('last-updated-time').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error("Failed to fetch BitKub prices:", error);
            }
        }

        function populateSymbolDropdown() {
            const select = document.getElementById('plan-symbol');
            const symbols = Object.keys(bitkubTickers)
                .filter(key => key.startsWith('THB_'))
                .map(key => key.replace('THB_', ''))
                .sort();
            
            select.innerHTML = '<option value="">Select Symbol</option>';
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });
        }

        function updateSymbolPrice() {
             const selectedSymbol = document.getElementById('plan-symbol').value;
             const priceEl = document.getElementById('selected-symbol-price');
             if (selectedSymbol && bitkubTickers[`THB_${selectedSymbol}`]) {
                 const price = parseFloat(bitkubTickers[`THB_${selectedSymbol}`].last);
                 priceEl.textContent = `฿ ${price.toLocaleString()}`;
             } else {
                 priceEl.textContent = '-';
             }
        }
        
        // --- PORTFOLIO CALCULATION ---
        function calculatePortfolioStats() {
            const totalDeposits = cashLog.reduce((sum, t) => sum + (t.type === 'DEPOSIT' ? t.amount : 0), 0);
            const totalWithdrawals = cashLog.reduce((sum, t) => sum + (t.type === 'WITHDRAWAL' ? t.amount : 0), 0);
            const totalBuys = costBasisLog.reduce((sum, t) => sum + (t.action === 'BUY' ? t.amount : 0), 0);
            const totalSells = costBasisLog.reduce((sum, t) => sum + (t.action === 'SELL' ? t.amount : 0), 0);
            const availableCash = totalDeposits - totalWithdrawals - totalBuys + totalSells;

            const holdings = {};
            [...costBasisLog].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(tx => {
                if(!holdings[tx.symbol]) holdings[tx.symbol] = { cumQty: 0, cumCost: 0 };
                const qty = tx.amount / tx.price;
                if (tx.action === 'BUY') {
                    const feeAdjustedQty = qty * (1 - (settings.feePercent/100));
                    holdings[tx.symbol].cumQty += feeAdjustedQty;
                    holdings[tx.symbol].cumCost += tx.amount;
                } else {
                    const avgCost = holdings[tx.symbol].cumQty > 0 ? holdings[tx.symbol].cumCost / holdings[tx.symbol].cumQty : 0;
                    holdings[tx.symbol].cumQty -= qty;
                    holdings[tx.symbol].cumCost -= qty * avgCost;
                }
                if (holdings[tx.symbol].cumQty < 1e-9) { holdings[tx.symbol].cumQty = 0; holdings[tx.symbol].cumCost = 0; }
            });
            
            const totalCryptoValue = Object.keys(holdings).reduce((sum, symbol) => {
                const ticker = `THB_${symbol}`;
                const currentPrice = (bitkubTickers[ticker] && bitkubTickers[ticker].last) ? parseFloat(bitkubTickers[ticker].last) : 0;
                return sum + (holdings[symbol].cumQty * currentPrice);
            }, 0);

            const totalPortfolioValue = totalCryptoValue + availableCash;
            const realizedPnL = tradesLog.filter(t => t.status === 'CLOSED').reduce((sum, t) => sum + (t.actualPnl || 0), 0);

            return { availableCash, totalCryptoValue, totalPortfolioValue, realizedPnL, holdings };
        }

        // --- DASHBOARD & CHARTS ---
        function renderDashboard(stats) {
            document.getElementById('db-total-portfolio-value').innerText = `${stats.totalPortfolioValue.toFixed(2)} THB`;
            document.getElementById('db-cash-balance').innerText = `${stats.availableCash.toFixed(2)} THB`;
            document.getElementById('db-realized-pnl').innerText = `${stats.realizedPnL.toFixed(2)} THB`;
            document.getElementById('db-crypto-value').innerText = `${stats.totalCryptoValue.toFixed(2)} THB`;
            
            const closedTrades = tradesLog.filter(t => t.status === 'CLOSED');
            const wins = closedTrades.filter(t => t.actualPnl > 0).length;
            document.getElementById('db-win-rate').innerText = closedTrades.length > 0 ? `${(wins / closedTrades.length * 100).toFixed(2)}%` : 'N/A';
            const totalR = closedTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
            document.getElementById('db-avg-r').innerText = closedTrades.length > 0 ? (totalR / closedTrades.length).toFixed(2) : 'N/A';

            const openTrades = tradesLog.filter(t => t.status === 'OPEN');
            const insightBody = document.getElementById('insight-table-body');
            insightBody.innerHTML = '';
            openTrades.forEach(trade => {
                const ticker = `THB_${trade.symbol}`;
                const currentPrice = (bitkubTickers[ticker] && bitkubTickers[ticker].last) ? parseFloat(bitkubTickers[ticker].last) : 0;
                const diff1 = currentPrice > 0 ? ((trade.tp1Eff - currentPrice) / currentPrice) * 100 * (trade.side === 'LONG' ? 1 : -1) : 0;
                const diff2 = currentPrice > 0 ? ((trade.tp2Eff - currentPrice) / currentPrice) * 100 * (trade.side === 'LONG' ? 1 : -1) : 0;
                insightBody.innerHTML += `<tr><td class="p-2 font-semibold">${trade.symbol}</td><td class="p-2 ${trade.side.toLowerCase()}">${trade.side}</td><td class="p-2">${trade.entryPrice.toFixed(4)}</td><td class="p-2">${currentPrice.toFixed(4)}</td><td class="p-2">${diff1.toFixed(2)}%</td><td class="p-2">${diff2.toFixed(2)}%</td></tr>`;
            });
        }
        
        function renderCharts(stats) {
            const timelineEvents = [ ...cashLog.map(t => ({ date: t.date, amount: t.type === 'DEPOSIT' ? t.amount : -t.amount })), ...tradesLog.filter(t => t.status === 'CLOSED' && t.exitDate).map(t => ({ date: t.exitDate, amount: t.actualPnl })) ].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulativeValue = 0;
            const equityData = timelineEvents.map(event => { cumulativeValue += event.amount; return { x: new Date(event.date), y: cumulativeValue }; });
            const ctxEquity = document.getElementById('equity-chart').getContext('2d');
            if(window.equityChart) window.equityChart.destroy();
            window.equityChart = new Chart(ctxEquity, { type: 'line', data: { datasets: [{ label: 'Portfolio Equity (THB)', data: equityData, borderColor: '#3b82f6', tension: 0.1 }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' }, adapters: { date: { locale: 'en-US' } } } } } });

            const cryptoValues = Object.keys(stats.holdings).map(symbol => {
                const ticker = `THB_${symbol}`;
                const currentPrice = (bitkubTickers[ticker] && bitkubTickers[ticker].last) ? parseFloat(bitkubTickers[ticker].last) : 0;
                return stats.holdings[symbol].cumQty * currentPrice;
            });
            const ctxHoldings = document.getElementById('holdings-chart').getContext('2d');
            if(window.holdingsChart) window.holdingsChart.destroy();
            window.holdingsChart = new Chart(ctxHoldings, { type: 'pie', data: { labels: Object.keys(stats.holdings), datasets: [{ label: 'Crypto Value (THB)', data: cryptoValues, backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'] }] } });
        }
        
        // --- CASH MANAGEMENT ---
        function renderCashLog() { /* Unchanged */ }
        document.getElementById('add-cash-form').addEventListener('submit', async (e) => { /* Unchanged */ });
        window.deleteCashItem = async (id) => { /* Unchanged */ };

        // --- TRADE PLANNER ---
        function addPlanEntryField() { /* Unchanged */ }
        document.getElementById('add-plan-entry-btn').addEventListener('click', addPlanEntryField);
        document.getElementById('trade-plan-form').addEventListener('submit', async function(e) { /* Unchanged */ });
        function renderTradePlanner() {
            const container = document.getElementById('active-plans-container');
            container.innerHTML = '';
            tradePlans.filter(p => p.status === 'ACTIVE').forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = 'bg-gray-700 p-4 rounded-lg';
                 let entriesHtml = plan.entries.map((entry, index) => {
                    return `<div class="grid grid-cols-5 gap-2 items-center text-sm p-2 ${index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-600'} rounded"><span>Entry ${index + 1} (${entry.percent}%)</span><span><strong>Entry:</strong> ${entry.entryPrice.toFixed(4)}</span><span><strong>Stop:</strong> ${entry.stopPrice.toFixed(4)}</span><span class="text-gray-400">Risk: ${plan.riskPercent}%</span>${entry.status === 'PLANNED' ? `<button class="btn-success text-xs p-1 rounded" onclick="executePlanEntry('${plan.id}', ${index})">Log Trade</button>` : `<span class="text-gray-400">Logged</span>`}</div>`;
                }).join('');
                planDiv.innerHTML = `<div class="flex justify-between items-center mb-2"><h3 class="text-lg font-bold">${plan.symbol} - <span class="text-base font-normal">${plan.strategy}</span></h3><button class="btn-danger text-xs p-1 rounded" onclick="archivePlan('${plan.id}')">Archive</button></div><p class="text-sm text-gray-300 mb-3">${plan.notes}</p><div class="space-y-1">${entriesHtml}</div>`;
                container.appendChild(planDiv);
            });
        }
        window.archivePlan = async (planId) => { /* Unchanged */ };

        window.executePlanEntry = async (planId, entryIndex) => {
            const plan = tradePlans.find(p => p.id === planId);
            if (!plan) return;
            const entry = plan.entries[entryIndex];
            const portfolioStats = calculatePortfolioStats();
            const riskThb = portfolioStats.totalPortfolioValue * (plan.riskPercent / 100);
            const stopDist = Math.abs(entry.entryPrice - entry.stopPrice);
            const fullQty = stopDist > 0 ? riskThb / stopDist : 0;
            const qty = fullQty * (entry.percent / 100);
            const side = entry.entryPrice > entry.stopPrice ? 'LONG' : 'SHORT';
            const newTrade = { id: `trd_${new Date().getTime()}`, date: new Date().toISOString().split('T')[0], symbol: plan.symbol, side, entryPrice: entry.entryPrice, positionSize: qty * entry.entryPrice, stopEff: entry.stopPrice, tp1Eff: side === 'LONG' ? entry.entryPrice + (stopDist * settings.targetR1) : entry.entryPrice - (stopDist * settings.targetR1), tp2Eff: side === 'LONG' ? entry.entryPrice + (stopDist * settings.targetR2) : entry.entryPrice - (stopDist * settings.targetR2), qty, riskThb, rr1: settings.targetR1, status: 'OPEN', exitPrice: null, exitDate: null, actualPnl: null, rMultiple: null };
            tradesLog.push(newTrade);
            plan.entries[entryIndex].status = 'EXECUTED';
            if (plan.entries.every(e => e.status === 'EXECUTED')) { plan.status = 'ARCHIVED'; }
            await saveData();
        };

        // --- TRADES & COST BASIS LOG ---
        document.getElementById('add-cost-basis-form').addEventListener('submit', async function(e) { /* Unchanged */ });
        function renderTradesLog() { /* Unchanged */ }
        function renderCostBasisLog() { /* Unchanged */ }
        window.deleteCostItem = async (id) => { /* Unchanged */ };

        // --- MODALS ---
        window.openModal = (tradeId) => { /* Unchanged */ };
        window.closeModal = () => { /* Unchanged */ };
        document.getElementById('close-trade-form').addEventListener('submit', async function(e) { /* Unchanged */ });
        
        // --- CHECKLIST LOGIC ---
        document.getElementById('checklist-container').addEventListener('change', () => {
            const requiredChecked = Array.from(document.querySelectorAll('.checklist-box[required]')).every(b => b.checked);
            document.getElementById('create-plan-btn').disabled = !requiredChecked;
        });

        // --- UI & TABS ---
        window.showTab = function(tabId) { /* Unchanged */ };
        function loadSettingsToUI() { /* Unchanged */ }
        document.getElementById('settings-form').addEventListener('submit', async function(e) { /* Unchanged */ });
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            showTab('dashboard');
            addPlanEntryField();
            document.getElementById('plan-symbol').addEventListener('change', updateSymbolPrice);
        });
        
    </script>
</body>
</html>



